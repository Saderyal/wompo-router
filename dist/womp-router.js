import{createContext as W,defineWomp as P,lazy as H,useCallback as O,useContext as y,useEffect as j,useMemo as C,useState as I,Suspense as w,html as x}from"womp";const v=(t,e=[],n=null,r=[])=>(t.forEach(a=>{if(a instanceof Route.class){const o=a.props,c=o.lazy?H(o.lazy):null,h={...o,parent:n,element:o.element,path:o.path,lazy:c,fallback:o.fallback,index:null,children:[]};c&&r.push(c),o.index&&(n.index=h),e.push(h),v(a.childNodes,h.children,h,r)}}),[e,r]),$=(t,e=[],n="")=>{for(const r of t){let a="";if(r.path){const o=n&&!n.endsWith("/")||!n&&!r.path.startsWith("/")?"/":"";a+=n+o+r.path,e.push([a,r])}r.children&&$(r.children,e,a)}return e},L=t=>{const e=Object.keys(t);return e.sort((n,r)=>{const a=t[n],o=t[r],c=Object.keys(a).filter(s=>s!=="segments").length,u=Object.keys(o).filter(s=>s!=="segments").length-c;if(u===0){let s=n.split("/"),f=r.split("/");const d=f.length-s.length;if(d!==0)return d;let p=0,i=0;for(let l=0;l<s.length;l++){const k=s[l],m=f[l];if(k.startsWith(":")||p++,m.startsWith(":")||i++,k.startsWith(":")||m.startsWith(":")||k.startsWith("*")||m.startsWith("*"))break}return i-p}return u}),t[e[0]]},z=(t,e)=>{const n={exact:null,parametric:{},fallbacks:{}},r=e!=="/"&&e.endsWith("/")?e.substring(0,e.length-1):e;for(const u of t){const[s,f]=u,d=s.endsWith("*");if(!d&&s.split("/").length!==r.split("/").length)continue;if(s===r){n.exact=f;break}if(!s.includes(":")&&!s.includes("*"))continue;const p=s.split("/");let i="";const l=[];for(let g=1;g<p.length;g++){const R=p[g];i+="\\/",R.startsWith(":")?(g===p.length-1?i+="(.*)":i+="(.*?)",l.push(R.substring(1))):R==="*"?(i+="(.*)",l.push("segments")):i+=R}const m=new RegExp(i,"g").exec(r);if(m){const g={};for(let R=1;R<m.length;R++)g[l[R-1]]=m[R];d?n.fallbacks[s]=[f,g]:n.parametric[s]=[f,g]}}const a=Object.keys(n.parametric),o=Object.keys(n.fallbacks);let c=[null,null];n.exact?c=[n.exact,{}]:a.length?c=L(n.parametric):o.length&&(c=L(n.fallbacks));const h=c[0]?.redirect||c[0]?.index?.redirect;if(h){const u=N(e,h);history.replaceState({},void 0,u),c=z(t,u)}return c},N=(t,e)=>e.startsWith("/")?e:t+(t.endsWith("/")||e.startsWith("#")?"":"/")+e,E=t=>t?x`
		<${S.Provider} value=${{...t}}>
			${t.lazy?t.fallback?x`
							<${w} fallback=${t.fallback}>
								<${t.lazy} />
							</${w}>
						`:x`<${t.lazy} />`:t.element}
		</${S.Provider}>
	`:null,b=W({params:null,hash:null,currentRoute:null,setNewRoute:null}),A=t=>{if(t){const e=document.getElementById(t);e&&e.scrollIntoView({block:"start",behavior:"smooth"})}};export function Routes({children:t}){const[e,n]=I(window.location.pathname),r=O((d,p=!0)=>{n(i=>{const l=N(i,d),[k,m]=l.split("#");return p&&i!==l&&(history.pushState({},null,l),m||window.scrollTo(0,0)),A(m),k})}),a=C(()=>{const[d,p]=v(t.nodes);return window.requestIdleCallback?p.forEach(i=>{requestIdleCallback(i)}):setTimeout(()=>{p.forEach(i=>{i()})},4e3),d},[]),o=C(()=>$(a),[]);j(()=>{window.addEventListener("popstate",()=>{r(window.location.pathname,!1)}),setTimeout(()=>{A(u.hash)},200)},[]);const[c,h]=z(o,e),u=C(()=>({hash:window.location.hash.split("#")[1],params:h,currentRoute:e,setNewRoute:r}),[e]);let s=c??{notFound:!0},f=null;for(s.nextRoute=f;s.parent;)f=s,s=s.parent,s.nextRoute=f;return x`<${b.Provider} value=${u}>
		${s.notFound?x`<div>Not found!</div>`:E(s)}
	</${b.Provider}>`}P(Routes,{name:"womp-routes"});const S=W(null);export function Route({route:t}){return x``}P(Route,{name:"womp-route"});export function ChildRoute(){const t=y(S);let e=null;if(t){const n=t.nextRoute;n?e=n:t.index&&(e=t.index)}return E(e)}P(ChildRoute,{name:"womp-child-route"});const B=(t,e)=>{let n=t;if(!n.startsWith("/")&&!n.startsWith("#")){let r=e;for(;r;){const a=r.path;if(a){const o=a.endsWith("/")?"":"/";n=r.path+o+n}r=r.parent}}return n};export function Link({to:t,children:e}){const n=useNavigate(),r=y(S),a=B(t,r);return x`<a href=${a} @click=${c=>{c.preventDefault(),n(a)}}>${e}</a> `}Link.css=":host { display: inline-block; }",P(Link,{name:"womp-link"});export function NavLink({to:t,children:e}){const n=useNavigate(),r=useCurrentRoute(),a=y(S),o=B(t,a);return x`<a class=${r===o&&"active"} href=${o} @click=${u=>{u.preventDefault(),n(o)}}>${e}</a>`}NavLink.css=":host { display: inline-block; }",P(NavLink,{name:"womp-nav-link"});export const useParams=()=>y(b).params,useNavigate=()=>y(b).setNewRoute,useCurrentRoute=()=>y(b).currentRoute;
