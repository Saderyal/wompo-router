import{createContext as $,defineWompo as P,lazy as H,useCallback as O,useContext as k,useEffect as j,useMemo as W,useState as M,Suspense as v,html as R}from"wompo";const w=(t,e=[],n=null)=>(t.forEach(r=>{if(r instanceof Route.class){const c=r.props,i=c.lazy?H(c.lazy):null,o={...c,parent:n,element:c.element,path:c.path,lazy:i,fallback:c.fallback,index:null,children:[]};c.index&&(n.index=o),e.push(o),w(r.childNodes,o.children,o)}}),e),z=(t,e=[],n="")=>{for(const r of t){let c="";if(r.path){const i=n&&!n.endsWith("/")||!n&&!r.path.startsWith("/")?"/":"";c+=n+i+r.path,e.push([c,r])}r.children&&z(r.children,e,c)}return e},L=t=>{const e=Object.keys(t);return e.sort((n,r)=>{const c=t[n],i=t[r],o=Object.keys(c).filter(s=>s!=="segments").length,a=Object.keys(i).filter(s=>s!=="segments").length-o;if(a===0){let s=n.split("/"),u=r.split("/");const l=u.length-s.length;if(l!==0)return l;let h=0,p=0;for(let m=0;m<s.length;m++){const y=s[m],f=u[m];if(y.startsWith(":")||h++,f.startsWith(":")||p++,y.startsWith(":")||f.startsWith(":")||y.startsWith("*")||f.startsWith("*"))break}return p-h}return a}),t[e[0]]},C=(t,e)=>{const n={exact:null,parametric:{},fallbacks:{}},r=e!=="/"&&e.endsWith("/")?e.substring(0,e.length-1):e;for(const a of t){const[s,u]=a,l=s.endsWith("*");if(!l&&s.split("/").length!==r.split("/").length)continue;if(s===r){n.exact=u;break}if(!s.includes(":")&&!s.includes("*"))continue;const h=s.split("/");let p="";const m=[];for(let g=1;g<h.length;g++){const d=h[g];p+="\\/",d.startsWith(":")?(g===h.length-1?p+="(.*)":p+="(.*?)",m.push(d.substring(1))):d==="*"?(p+="(.*)",m.push("segments")):p+=d}const f=new RegExp(p,"g").exec(r);if(f){const g={};for(let d=1;d<f.length;d++)g[m[d-1]]=f[d];l?n.fallbacks[s]=[u,g]:n.parametric[s]=[u,g]}}const c=Object.keys(n.parametric),i=Object.keys(n.fallbacks);let o=[null,null];n.exact?o=[n.exact,{}]:c.length?o=L(n.parametric):i.length&&(o=L(n.fallbacks));const x=o[0]?.redirect||o[0]?.index?.redirect;if(x){const a=N(e,x);history.replaceState({},void 0,a),o=C(t,a)}return o},N=(t,e)=>e.startsWith("/")?e:t+(t.endsWith("/")||e.startsWith("#")?"":"/")+e,A=t=>t?R`
		<${b.Provider} value=${{...t}}>
			${t.lazy?t.fallback?R`
							<${v} fallback=${t.fallback}>
								<${t.lazy} />
							</${v}>
						`:R`<${t.lazy} />`:t.element}
		</${b.Provider}>
	`:null,S=$({params:null,hash:null,currentRoute:null,setNewRoute:null,routes:[]}),B=t=>{if(t){const e=document.getElementById(t);e&&e.scrollIntoView({block:"start",behavior:"smooth"})}};export function Routes({children:t}){const[e,n]=M(window.location.pathname),r=O((l,h=!0)=>{n(p=>{const m=N(p,l),[y,f]=m.split("#");return h&&p!==m&&(history.pushState({},null,m),f||window.scrollTo(0,0)),B(f),y})}),c=W(()=>w(t.nodes),[]),i=W(()=>z(c),[]);j(()=>{window.addEventListener("popstate",()=>{r(window.location.pathname,!1)}),setTimeout(()=>{B(a.hash)},200)},[]);const[o,x]=C(i,e),a=W(()=>({hash:window.location.hash.split("#")[1],params:x,currentRoute:e,setNewRoute:r,routes:i}),[e]);let s={notFound:!0};if(o){if(s=o,o.meta?.title){document.title=o.meta.title;const l=document.querySelector('meta[property="og:title"]');l&&l.setAttribute("content",o.meta.title)}if(o.meta?.description){const l=document.querySelector('meta[name="description"]');l&&l.setAttribute("content",o.meta.description);const h=document.querySelector('meta[property="og:description"]');h&&h.setAttribute("content",o.meta.description)}}let u=null;for(s.nextRoute=u;s.parent;)u=s,s=s.parent,s.nextRoute=u;return R`<${S.Provider} value=${a}>
		${s.notFound?R`<div>Not found!</div>`:A(s)}
	</${S.Provider}>`}P(Routes,{name:"womp-routes"});const b=$(null);export function Route(t){return R``}P(Route,{name:"wompo-route"});export function ChildRoute(){const t=k(b);let e=null;if(t){const n=t.nextRoute;n?e=n:t.index&&(e=t.index)}return A(e)}P(ChildRoute,{name:"wompo-child-route"});const E=(t,e)=>{let n=t;if(!n.startsWith("/")&&!n.startsWith("#")){let r=e;for(;r;){const c=r.path;if(c){const i=c.endsWith("/")?"":"/";n=r.path+i+n}r=r.parent}}return n};export function Link({to:t,children:e}){const n=useNavigate(),r=k(b),c=useRoutes(),i=E(t,r);return R`<a href=${i} @click=${a=>{a.preventDefault(),n(i)}} @mouseenter=${()=>{const[a]=C(c,i.split("#")[0]);a&&a.lazy&&a.lazy()}}>${e}</a>`}Link.css=":host { display: inline-block; }",P(Link,{name:"wompo-link"});export function NavLink({to:t,children:e}){const n=useNavigate(),r=useCurrentRoute(),c=useRoutes(),i=k(b),o=E(t,i);return R`<a
		class=${r===o&&"active"}
		href=${o}
		@click=${u=>{u.preventDefault(),n(o)}}
		@mouseenter=${()=>{const[u]=C(c,o.split("#")[0]);u&&u.lazy&&u.lazy()}}
	>
		${e}
	</a>`}NavLink.css=":host { display: inline-block; }",P(NavLink,{name:"wompo-nav-link"});export const useParams=()=>k(S).params,useNavigate=()=>k(S).setNewRoute,useCurrentRoute=()=>k(S).currentRoute,useRoutes=()=>k(S).routes;
